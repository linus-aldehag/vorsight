name: Create Daily Unified Release

on:
  # Run daily at 2 AM UTC (after nightly builds have completed)
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  create-unified-release:
    name: Create Unified Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Get Today's Date
      id: date
      run: |
        DATE=$(date +'%Y.%m.%d')
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "Today's date: $DATE"

    - name: Download Latest Windows Installer
      uses: dawidd6/action-download-artifact@v3
      continue-on-error: true
      with:
        workflow: build-windows.yml
        workflow_conclusion: success
        name_is_regexp: true
        name: 'windows-installer-v.*'
        path: artifacts/windows/
        search_artifacts: true
        if_no_artifact_found: warn

    - name: Download Latest Linux Server Package
      uses: dawidd6/action-download-artifact@v3
      continue-on-error: true
      with:
        workflow: build-linux.yml
        workflow_conclusion: success
        name_is_regexp: true
        name: 'linux-server-v.*'
        path: artifacts/linux/
        search_artifacts: true
        if_no_artifact_found: warn

    - name: Check if Release Already Exists
      id: check_release
      run: |
        if gh release view "v${{ steps.date.outputs.date }}" &>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Release v${{ steps.date.outputs.date }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Release v${{ steps.date.outputs.date }} does not exist yet"
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Check for New Artifacts
      id: check_artifacts
      if: steps.check_release.outputs.exists == 'false'
      run: |
        # Check if we have any artifacts downloaded
        WINDOWS_COUNT=$(find artifacts/windows -name "*.exe" 2>/dev/null | wc -l)
        LINUX_COUNT=$(find artifacts/linux -name "*.tar.gz" 2>/dev/null | wc -l)
        
        echo "Windows artifacts found: $WINDOWS_COUNT"
        echo "Linux artifacts found: $LINUX_COUNT"
        
        if [ "$WINDOWS_COUNT" -gt 0 ] || [ "$LINUX_COUNT" -gt 0 ]; then
          echo "has_artifacts=true" >> $GITHUB_OUTPUT
          echo "âœ“ New artifacts available for release"
        else
          echo "has_artifacts=false" >> $GITHUB_OUTPUT
          echo "âœ— No new artifacts found - skipping release"
        fi

    - name: Create or Update Unified Release
      if: steps.check_release.outputs.exists == 'false' && steps.check_artifacts.outputs.has_artifacts == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release v${{ steps.date.outputs.date }}
        body: |
          ## VÃ¶rsight Daily Build - ${{ steps.date.outputs.date }}
          
          This is an automated daily release combining the latest Windows and Linux builds.
          
          ### ðŸ“¦ What's Included
          
          - **Windows Installer** (`VorsightSetup-v*.exe`)
            - VÃ¶rsight Service (Windows background service)
            - VÃ¶rsight Agent (user session component)
            - Inno Setup installer with configuration wizard
          
          - **Linux Server Package** (`vorsight-server-v*.tar.gz`)
            - Node.js server with API and WebSocket support
            - React web dashboard (pre-built)
            - Setup and deployment scripts
            - Database migrations
          
          ### ðŸ“– Installation
          
          **Windows:**
          1. Download `VorsightSetup-v*.exe`
          2. Run the installer
          3. Follow the configuration wizard
          
          **Linux:**
          ```bash
          tar -xzf vorsight-server-v*.tar.gz
          cd vorsight-server
          sudo ./setup.sh
          ```
          
          See the [README](https://github.com/${{ github.repository }}) for detailed installation and configuration instructions.
          
          ---
          
          **Note:** Individual component releases are also available with specific version numbers:
          - `windows-v*` - Windows client only
          - `server-v*` - Linux server only
        files: |
          artifacts/windows/*.exe
          artifacts/linux/*.tar.gz
        draft: false
        prerelease: false
